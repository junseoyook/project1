<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #007AFF;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --gray-color: #8E8E93;
            --light-gray: #F2F2F7;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--light-gray);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            color: #000;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--gray-color);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: #fff;
        }

        .btn-danger {
            background: var(--danger-color);
            color: #fff;
        }

        .token-list {
            margin-top: 20px;
        }

        .token-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .token-info {
            flex: 1;
        }

        .token-url {
            color: var(--primary-color);
            word-break: break-all;
            margin-top: 5px;
        }

        .token-expiry {
            color: var(--gray-color);
            font-size: 14px;
        }

        .token-actions {
            display: flex;
            gap: 10px;
        }

        .copy-btn {
            background: var(--light-gray);
            color: var(--gray-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: var(--gray-color);
            color: #fff;
        }

        .device-checkboxes {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--light-gray);
            transition: background-color 0.3s;
        }

        .checkbox-label:hover {
            background: var(--border-color);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>관리자 대시보드</h1>
        </div>

        <div class="card">
            <h2>새 토큰 생성</h2>
                <form id="tokenForm">
                    <div class="form-group">
                    <label for="deviceType">발급할 디바이스</label>
                    <div class="device-checkboxes">
                        <label class="checkbox-label">
                            <input type="checkbox" id="parkingCheckbox" value="ESP32_001">
                            <span>주차장 차단기</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="doorCheckbox" value="ESP32_002">
                            <span>현관문</span>
                        </label>
                    </div>
                    </div>
                <div class="form-group">
                    <label for="uses">사용 가능 횟수</label>
                    <input type="number" id="uses" class="form-control" value="10" min="1" max="100" required>
                    </div>
                <div class="form-group">
                    <label for="expiresIn">만료 시간 (시간)</label>
                    <input type="number" id="expiresIn" class="form-control" value="24" min="1" max="168" required>
                </div>
                <button type="submit" class="btn btn-primary">토큰 생성</button>
            </form>
        </div>

        <div class="card">
            <h2>생성된 토큰 목록</h2>
            <div id="tokenList" class="token-list">
                <!-- 토큰 목록이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>

    <script>
        const adminKey = 'your-admin-key'; // 실제 운영에서는 환경변수로 관리해야 합니다

        // 토큰 생성
        document.getElementById('tokenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const parkingChecked = document.getElementById('parkingCheckbox').checked;
            const doorChecked = document.getElementById('doorCheckbox').checked;
            const uses = parseInt(document.getElementById('uses').value);
            const expiresIn = parseInt(document.getElementById('expiresIn').value) * 60 * 60 * 1000;
            
            if (!parkingChecked && !doorChecked) {
                alert('최소 하나의 디바이스를 선택해주세요.');
                return;
            }
            
            try {
                const tokens = [];
                
                if (parkingChecked) {
                    const response = await fetch('/api/tokens', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-key': adminKey
                        },
                        body: JSON.stringify({
                            deviceId: 'ESP32_001',
                            type: 'parking',
                            uses,
                            expiresIn
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        tokens.push(data);
                    } else {
                        throw new Error(data.error);
                    }
                }
                
                if (doorChecked) {
                    const response = await fetch('/api/tokens', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-key': adminKey
                        },
                        body: JSON.stringify({
                            deviceId: 'ESP32_002',
                            type: 'door',
                            uses,
                            expiresIn
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        tokens.push(data);
                    } else {
                        throw new Error(data.error);
                    }
                }
                
                tokens.forEach(addTokenToList);
                alert('토큰이 생성되었습니다');
            } catch (error) {
                alert(error.message);
            }
        });

        // 토큰 목록에 추가
        function addTokenToList(tokenData) {
            const tokenList = document.getElementById('tokenList');
            const tokenItem = document.createElement('div');
            tokenItem.className = 'token-item';
            
            const expiryDate = new Date(tokenData.expiresAt);
            
            tokenItem.innerHTML = `
                <div class="token-info">
                    <div>디바이스: ${tokenData.deviceId}</div>
                    <div class="token-url">${tokenData.url}</div>
                    <div class="token-expiry">
                        만료: ${expiryDate.toLocaleString()} | 남은 사용 횟수: ${tokenData.remainingUses}
                    </div>
                </div>
                <div class="token-actions">
                    <button class="copy-btn" onclick="copyToClipboard('${tokenData.url}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            `;
            
            tokenList.prepend(tokenItem);
        }

        // 클립보드에 복사
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert('URL이 클립보드에 복사되었습니다'))
                .catch(err => alert('복사에 실패했습니다: ' + err));
        }

        // 페이지 로드 시 토큰 목록 불러오기
        async function loadTokens() {
            try {
                const response = await fetch('/api/tokens', {
                    headers: {
                        'x-admin-key': adminKey
                    }
                });
                
                if (response.ok) {
                    const tokens = await response.json();
                    tokens.forEach(addTokenToList);
                }
            } catch (error) {
                console.error('토큰 목록을 불러오는데 실패했습니다:', error);
            }
        }

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', loadTokens);
    </script>
</body>
</html> 