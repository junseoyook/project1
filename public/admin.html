<div class="card">
    <div class="card-header">
        <h2 class="text-center mb-0">토큰 관리</h2>
    </div>
    <div class="card-body">
        <form id="tokenForm" class="mb-4">
            <div class="mb-3">
                <label for="phoneNumber" class="form-label">고객 전화번호</label>
                <input type="tel" class="form-control" id="phoneNumber" 
                       placeholder="01012345678" pattern="[0-9]{10,11}" required>
                <div class="form-text">'-' 없이 숫자만 입력해주세요</div>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary" id="generateButton">
                    토큰 생성
                </button>
            </div>
        </form>
        <div id="tokenResult" class="alert alert-success d-none">
            <h5>토큰이 생성되었습니다</h5>
            <p class="mb-2">아래 URL이 고객의 휴대폰으로 전송되었습니다:</p>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="tokenUrl" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">
                    복사
                </button>
            </div>
            <small class="text-muted">
                * URL은 24시간 동안 유효하며, 최대 10회까지 사용할 수 있습니다.<br>
                * SMS 전송에 실패한 경우 URL을 복사하여 수동으로 전달해주세요.
            </small>
        </div>
    </div>
</div>

<script>
document.getElementById('tokenForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const generateButton = document.getElementById('generateButton');
    const phoneNumber = document.getElementById('phoneNumber').value;
    
    try {
        generateButton.disabled = true;
        generateButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 생성 중...';
        
        const response = await fetch('/api/generate-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ phoneNumber })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const tokenResult = document.getElementById('tokenResult');
            const tokenUrl = document.getElementById('tokenUrl');
            const baseUrl = window.location.origin;
            const fullUrl = `${baseUrl}/customer/${data.url}`;
            
            tokenUrl.value = fullUrl;
            tokenResult.classList.remove('d-none');
            
            if (!data.smsSent) {
                tokenResult.classList.remove('alert-success');
                tokenResult.classList.add('alert-warning');
                tokenResult.querySelector('p').textContent = 'SMS 전송에 실패했습니다. URL을 복사하여 수동으로 전달해주세요:';
            }
        } else {
            throw new Error(data.error || '토큰 생성에 실패했습니다.');
        }
    } catch (error) {
        alert(error.message);
    } finally {
        generateButton.disabled = false;
        generateButton.textContent = '토큰 생성';
    }
});

function copyToClipboard() {
    const tokenUrl = document.getElementById('tokenUrl');
    tokenUrl.select();
    document.execCommand('copy');
    alert('URL이 클립보드에 복사되었습니다.');
}
</script> 