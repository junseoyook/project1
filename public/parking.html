<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ï£ºÏ∞®Ïû• Î¶¨Î™®Ïª®</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }
        .remote-eink {
            width: 100vw;
            max-width: 420px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            padding: 0 12px;
        }
        .remote-card {
            background: #fff;
            border: 1.5px solid #ddd;
            border-radius: 18px;
            box-shadow: 0 2px 12px #0001;
            padding: 36px 24px 28px 24px;
            max-width: 340px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .remote-toggle-row {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: 36px 0 32px 0;
            gap: 18px;
        }
        .toggle-label {
            font-size: 1.35rem;
            font-family: 'Consolas', 'Pretendard', monospace;
            color: #222;
            opacity: 0.6;
            font-weight: 600;
            letter-spacing: 1.5px;
            user-select: none;
            transition: opacity 0.2s;
        }
        .toggle-label.active {
            opacity: 1;
            color: #111;
        }
        .toggle-switch {
            width: 92px;
            height: 38px;
            border-radius: 19px;
            border: 2px solid #bbb;
            background: #fafafa;
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            outline: none;
            padding: 0;
            margin: 0 8px;
            transition: border 0.2s, background 0.2s;
        }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 1.5px solid #bbb;
            box-shadow: 0 1px 4px #0001;
            transition: left 0.25s cubic-bezier(.4,1.4,.6,1), background 0.2s, border 0.2s;
        }
        .toggle-switch.open .toggle-slider {
            left: 57px;
            background: #bfefff;
            border: 1.5px solid #1ca7ec;
        }
        .toggle-switch.open {
            border: 2px solid #1ca7ec;
            background: #eaf8ff;
        }
        .toggle-label.left.active {
            color: #ff6f61;
            opacity: 1;
        }
        .toggle-label.right.active {
            color: #1ca7ec;
            opacity: 1;
        }
        .remote-status {
            font-size: 1.1rem;
            color: #555;
            text-align: center;
            margin-top: 18px;
            min-height: 22px;
            user-select: none;
        }
        .remote-guide {
            color: #888;
            font-size: 0.98rem;
            margin-top: 18px;
            text-align: center;
            user-select: none;
        }
        @media (max-width: 600px) {
            .remote-card {
                padding: 24px 6px 18px 6px;
            }
            .remote-toggle-row {
                margin: 24px 0 18px 0;
            }
            .toggle-label {
                font-size: 1.05rem;
            }
            .toggle-switch {
                width: 68px;
                height: 28px;
            }
            .toggle-slider {
                width: 20px;
                height: 20px;
                top: 2.5px;
                left: 2.5px;
            }
            .toggle-switch.open .toggle-slider {
                left: 41px;
            }
        }
    </style>
</head>
<body>
    <div class="remote-eink">
        <div class="remote-card">
            <div class="remote-toggle-row">
                <span class="toggle-label left" id="labelClose">CLOSE</span>
                <button class="toggle-switch" id="toggleSwitch" onclick="toggleRemote()">
                    <span class="toggle-slider" id="toggleSlider"></span>
                </button>
                <span class="toggle-label right" id="labelOpen">OPEN</span>
            </div>
            <div class="remote-status" id="iosStatus">ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...</div>
            <div class="remote-guide">ÏûÖÏ∂úÏ∞® ÌõÑ Íº≠ Îã´Ìûò Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî</div>
        </div>
    </div>
    <script>
        let isConnected = false;
        let token = null;
        let isOpen = false; // false=CLOSE, true=OPEN
        function getTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }
        async function validateToken() {
            token = getTokenFromUrl();
            if (!token) {
                showError('ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§. Ïò¨Î∞îÎ•∏ ÎßÅÌÅ¨Î°ú Ï†ëÍ∑ºÌï¥Ï£ºÏÑ∏Ïöî.');
                return false;
            }
            try {
                const response = await fetch('/api/tokens/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await response.json();
                if (!data.success || !data.valid) {
                    throw new Error(data.message || 'ÌÜ†ÌÅ∞Ïù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                }
                return true;
            } catch (error) {
                showError(error.message);
                return false;
            }
        }
        function showError(message) {
            const iosStatus = document.getElementById('iosStatus');
            iosStatus.textContent = message;
            iosStatus.style.color = '#FF3B30';
            document.getElementById('toggleSwitch').disabled = true;
        }
        async function checkConnection() {
            if (!await validateToken()) return;
            const iosStatus = document.getElementById('iosStatus');
            try {
                const response = await fetch('/api/device/command/ESP32_001', { method: 'GET' });
                const data = await response.json();
                if (data.command === 'open' || data.command === 'close' || data.command === null) {
                    isConnected = true;
                    iosStatus.innerHTML = '<span style="color:#34C759;">üü¢ Ïó∞Í≤∞Îê®</span>';
                    document.getElementById('toggleSwitch').disabled = false;
                } else {
                    throw new Error('Ïó∞Í≤∞ Ïã§Ìå®');
                }
            } catch (error) {
                isConnected = false;
                iosStatus.innerHTML = '<span style="color:#FF3B30;">üî¥ ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®</span>';
                document.getElementById('toggleSwitch').disabled = true;
                setTimeout(checkConnection, 5000);
            }
        }
        function updateToggleUI() {
            const toggle = document.getElementById('toggleSwitch');
            const slider = document.getElementById('toggleSlider');
            const labelClose = document.getElementById('labelClose');
            const labelOpen = document.getElementById('labelOpen');
            if (isOpen) {
                toggle.classList.add('open');
                labelOpen.classList.add('active');
                labelClose.classList.remove('active');
            } else {
                toggle.classList.remove('open');
                labelOpen.classList.remove('active');
                labelClose.classList.add('active');
            }
        }
        async function toggleRemote() {
            if (!isConnected) return;
            const toggle = document.getElementById('toggleSwitch');
            toggle.disabled = true;
            // Î™®Î∞îÏùº ÏßÑÎèô
            if (window.navigator.vibrate) {
                window.navigator.vibrate(80);
            }
            // ÏÑúÎ≤ÑÏóê Î™ÖÎ†π Ï†ÑÏÜ° (UIÎäî ÏùëÎãµ ÌõÑÏóêÎßå Ï†ÑÌôò)
            const nextState = !isOpen;
            const command = nextState ? 'open' : 'close';
            let success = false;
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(
                        command === 'open' ? '/api/parking/open' : '/api/parking/close',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-device-id': 'ESP32_001',
                                'x-device-secret': 'esp32-secret-key'
                            }
                        }
                    );
                    const data = await response.json();
                    if (response.ok && data.success) {
                        success = true;
                        break;
                    }
                } catch (e) {}
                await new Promise(res => setTimeout(res, 400));
            }
            if (success) {
                isOpen = nextState;
                updateToggleUI();
                document.getElementById('iosStatus').innerHTML = '';
            } else {
                document.getElementById('iosStatus').innerHTML = '<span style="color:#FF3B30;">Î™ÖÎ†π Ï†ÑÏÜ° Ïã§Ìå®, Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.</span>';
            }
            setTimeout(() => {
                toggle.disabled = false;
            }, 3000);
        }
        document.addEventListener('DOMContentLoaded', async () => {
            updateToggleUI();
            if (await validateToken()) {
                checkConnection();
            }
        });
        if (window.navigator.standalone) {
            document.documentElement.style.setProperty('--safe-area-inset-top', '44px');
        }
    </script>
</body>
</html> 