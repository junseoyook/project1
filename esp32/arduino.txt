#include <WiFi.h>
#include <HTTPClient.h>
#include <WiFiClientSecure.h>
#include <ArduinoJson.h>

// ğŸ“¡ WiFi ì„¤ì •
const char* ssid = "TP-LINK_43B2";
const char* password = "41151501";

// ğŸŒ ì„œë²„ ì„¤ì •
const char* serverUrl = "https://project1-production-f338.up.railway.app";
const char* deviceId = "ESP32_001";
const char* deviceSecret = "esp32-secret-key";

// ğŸ“ í•€ ì„¤ì •
const int closePin = 25;   // K1 ì œì–´ í•€
const int openPin  = 26;   // K2 ì œì–´ í•€

// ì£¼ê¸°
unsigned long lastCheck = 0;
const unsigned long interval = 1000;  // 1ì´ˆë§ˆë‹¤ ì„œë²„ í™•ì¸

WiFiClientSecure client;
String lastCommand = "";  // ë§ˆì§€ë§‰ ëª…ë ¹ ì €ì¥

void setup() {
  Serial.begin(115200);

  pinMode(closePin, OUTPUT);
  pinMode(openPin, OUTPUT);
  digitalWrite(closePin, LOW);
  digitalWrite(openPin, LOW);

  client.setInsecure();  // SSL ì¸ì¦ì„œ ë¬´ì‹œ

  WiFi.begin(ssid, password);
  Serial.print("WiFi ì—°ê²° ì¤‘");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi ì—°ê²°ë¨");
}

void loop() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi ì¬ì—°ê²° ì‹œë„");
    WiFi.reconnect();
    return;
  }

  unsigned long currentMillis = millis();
  if (currentMillis - lastCheck >= interval) {
    lastCheck = currentMillis;
    checkServer();
  }
}

void checkServer() {
  HTTPClient https;
  String url = String(serverUrl) + "/api/device/command/" + deviceId;

  if (https.begin(client, url)) {
    https.addHeader("Authorization", deviceSecret);
    https.addHeader("Content-Type", "application/json");

    int httpCode = https.GET();
    String payload = https.getString();

    if (httpCode == 200) {
      StaticJsonDocument<200> doc;
      DeserializationError error = deserializeJson(doc, payload);
      if (error) {
        Serial.println("JSON íŒŒì‹± ì˜¤ë¥˜");
        https.end();
        return;
      }

      const char* command = doc["command"];
      if (!command) {
        https.end();
        return;
      }

      // ğŸ” ì¤‘ë³µ ëª…ë ¹ ë¬´ì‹œ
      if (lastCommand == String(command)) {
        https.end();
        return;
      }

      lastCommand = String(command);  // ìƒˆë¡œìš´ ëª…ë ¹ ì €ì¥

      if (strcmp(command, "close") == 0) {
        Serial.println("ë‹«í˜ ëª…ë ¹ ì‹¤í–‰");
        controlBarrier(closePin);
        notifyStatus("closed");
      } 
      else if (strcmp(command, "open") == 0) {
        Serial.println("ì—´ë¦¼ ëª…ë ¹ ì‹¤í–‰");
        controlBarrier(openPin);
        notifyStatus("opened");
      }
    }
  }
  https.end();
}

void notifyStatus(const char* status) {
  HTTPClient https;
  String url = String(serverUrl) + "/api/device/status/" + deviceId;

  if (https.begin(client, url)) {
    https.addHeader("Authorization", deviceSecret);
    https.addHeader("Content-Type", "application/json");

    StaticJsonDocument<200> doc;
    doc["status"] = status;
    doc["timestamp"] = millis();

    String jsonString;
    serializeJson(doc, jsonString);
    int httpCode = https.POST(jsonString);

    if (httpCode == 200) {
      Serial.println("ìƒíƒœ ì „ì†¡ ì™„ë£Œ");
    }
  }
  https.end();
}

void controlBarrier(int pin) {
  digitalWrite(pin, HIGH);
  delay(500);  // 0.5ì´ˆ ìœ ì§€
  digitalWrite(pin, LOW);
  Serial.print("í•€ ");
  Serial.print(pin);
  Serial.println(" ì‘ë™ ì™„ë£Œ (HIGH â†’ 0.5s â†’ LOW)");
}
